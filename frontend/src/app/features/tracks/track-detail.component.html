<div class="mg-page track-detail-page">
    <div class="mg-page-header">
        <div class="mg-page-title-wrap">
            <h1 class="mg-page-title">
                <mat-icon>flag</mat-icon>
                {{ trackDetail?.name || 'Track Detail' }}
            </h1>
            <p class="mg-page-subtitle">Detailed analytics, records and progression by vehicle.</p>
        </div>
        <div class="mg-page-actions">
            <button mat-stroked-button color="primary" (click)="goBack()">
                <mat-icon>arrow_back</mat-icon>
                Back to Tracks
            </button>
        </div>
    </div>

    <app-page-loader *ngIf="loading" icon="track_changes" message="Loading track detail..." minHeight="280px"></app-page-loader>

    <div *ngIf="!loading && error" class="mg-empty-state">
        <mat-icon>error_outline</mat-icon>
        <p>{{ error }}</p>
        <button mat-raised-button color="primary" (click)="goBack()">Back to Tracks</button>
    </div>

    <div *ngIf="!loading && !error && trackDetail" class="track-detail-content">
        <mat-card class="mg-surface-card track-hero-card">
            <mat-card-content>
                <div class="hero-layout">
                    <div class="hero-info">
                        <div class="header-row">
                            <div class="track-icon">
                                <mat-icon>place</mat-icon>
                            </div>
                            <div class="title-section">
                                <h2>{{ trackDetail.name }}</h2>
                                <div class="location-badge" *ngIf="trackDetail.location">
                                    <mat-icon>location_on</mat-icon>
                                    <span>{{ trackDetail.location }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="description-section" *ngIf="trackDetail.description">
                            <p>{{ trackDetail.description }}</p>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="label">Length</span>
                                <div class="value">
                                    <mat-icon>straighten</mat-icon>
                                    <span>{{ trackDetail.length_meters ? (trackDetail.length_meters | number) + ' m' : '-' }}</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="label">Sessions</span>
                                <div class="value">
                                    <mat-icon>event</mat-icon>
                                    <span>{{ trackDetail.total_sessions }}</span>
                                </div>
                            </div>
                            <div class="stat-item highlight">
                                <span class="label">Best Time</span>
                                <div class="value">
                                    <mat-icon>emoji_events</mat-icon>
                                    <span>{{ trackDetail.best_lap_time || '-' }}</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="label">Vehicles</span>
                                <div class="value">
                                    <mat-icon>directions_car</mat-icon>
                                    <span>{{ trackDetail.vehicle_groups.length }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="hero-map">
                        <div class="map-container" *ngIf="trackMapUrl; else mapUnavailableTpl">
                            <img
                                [src]="trackMapUrl"
                                [alt]="trackDetail.name + ' track map'"
                                loading="lazy"
                                decoding="async"
                                (error)="onTrackMapLoadError()">
                        </div>
                        <ng-template #mapUnavailableTpl>
                            <div class="map-unavailable" *ngIf="mapUnavailable">
                                <mat-icon>map</mat-icon>
                                <p>Track map unavailable</p>
                            </div>
                        </ng-template>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="mg-surface-card chart-card" *ngIf="chartSeries.length > 0">
            <mat-card-header>
                <mat-card-title>
                    <mat-icon>timeline</mat-icon>
                    Vehicle Comparison Timeline
                </mat-card-title>
                <mat-card-subtitle>Session = best lap of each day. Record = best historical lap for that vehicle on this circuit.</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <app-circuit-evolution-chart [data]="chartSeries" height="350px"></app-circuit-evolution-chart>
            </mat-card-content>
        </mat-card>

        <mat-card class="mg-surface-card vehicles-card">
            <mat-card-header>
                <mat-card-title>
                    <mat-icon>leaderboard</mat-icon>
                    Comparison by Vehicle
                </mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="vehicle-groups">
                    <div *ngFor="let group of trackDetail.vehicle_groups; let i = index" class="vehicle-group">
                        <div class="vehicle-header">
                            <div class="position-badge" [class.gold]="i === 0" [class.silver]="i === 1" [class.bronze]="i === 2">
                                #{{ i + 1 }}
                            </div>
                            <div class="vehicle-info-header">
                                <h3>{{ group.vehicle_name }}</h3>
                                <div class="vehicle-best-time">
                                    <mat-icon>timer</mat-icon>
                                    {{ group.best_lap_time }}
                                </div>
                            </div>
                            <mat-chip class="session-count">{{ group.records.length }} sessions</mat-chip>
                        </div>

                        <div class="records-table-container">
                            <table mat-table [dataSource]="group.records" class="mg-table records-table">
                                <ng-container matColumnDef="date_achieved">
                                    <th mat-header-cell *matHeaderCellDef>Date</th>
                                    <td mat-cell *matCellDef="let record">{{ record.date_achieved | date:'dd/MM/yyyy' }}</td>
                                </ng-container>

                                <ng-container matColumnDef="best_lap_time">
                                    <th mat-header-cell *matHeaderCellDef>Time</th>
                                    <td mat-cell *matCellDef="let record" class="time-cell">{{ record.best_lap_time }}</td>
                                </ng-container>

                                <ng-container matColumnDef="weather_conditions">
                                    <th mat-header-cell *matHeaderCellDef>Weather</th>
                                    <td mat-cell *matCellDef="let record">{{ record.weather_conditions || '-' }}</td>
                                </ng-container>

                                <ng-container matColumnDef="tire_compound">
                                    <th mat-header-cell *matHeaderCellDef>Tires</th>
                                    <td mat-cell *matCellDef="let record">{{ record.tire_compound || '-' }}</td>
                                </ng-container>

                                <ng-container matColumnDef="group">
                                    <th mat-header-cell *matHeaderCellDef>Group</th>
                                    <td mat-cell *matCellDef="let record">{{ record.group || '-' }}</td>
                                </ng-container>

                                <ng-container matColumnDef="organizer">
                                    <th mat-header-cell *matHeaderCellDef>Organizer</th>
                                    <td mat-cell *matCellDef="let record">{{ record.organizer || '-' }}</td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
</div>
