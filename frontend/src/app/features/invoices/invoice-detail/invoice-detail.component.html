<div class="mg-page" *ngIf="!loading; else loadingTpl">
    <div class="mg-page-header">
        <div class="mg-page-title-wrap">
            <h2 class="mg-page-title">
                <button mat-icon-button routerLink="/invoices" aria-label="Back to invoices">
                    <mat-icon>arrow_back</mat-icon>
                </button>
                Invoice Details
            </h2>
            <p class="mg-page-subtitle">Review extracted information, maintenance lines and invoice image.</p>
        </div>
        <div class="mg-page-actions">
            <mat-chip-set>
                <mat-chip [color]="getStatusColor(invoice?.status || '')" selected>
                    {{invoice?.status | uppercase}}
                </mat-chip>
            </mat-chip-set>
        </div>
    </div>

    <div class="content-grid">
        <div class="details-column">
            <mat-card class="mg-surface-card">
                <mat-card-header>
                    <mat-card-title>General Information</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="info-row">
                        <span class="label">Number:</span>
                        <span class="value">{{invoice?.number || '-'}}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Date:</span>
                        <span class="value">{{invoice?.date ? (invoice?.date | date) : '-'}}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Subtotal:</span>
                        <span class="value price">{{extractedData?.subtotal | currency:'EUR'}}</span>
                    </div>
                    <div class="info-row" *ngIf="extractedData?.tax_amount">
                        <span class="label">Tax (IVA):</span>
                        <span class="value price">{{extractedData?.tax_amount | currency:'EUR'}}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Total Amount:</span>
                        <span class="value price">{{invoice?.amount | currency:'EUR'}}</span>
                    </div>
                </mat-card-content>
            </mat-card>

            <mat-card *ngIf="extractedData?.supplier_name" class="mg-surface-card">
                <mat-card-header>
                    <mat-card-title>Supplier</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="info-row">
                        <span class="label">Name:</span>
                        <span class="value">{{extractedData?.supplier_name}}</span>
                    </div>
                    <div class="info-row" *ngIf="extractedData?.supplier_address">
                        <span class="label">Address:</span>
                        <span class="value">{{extractedData?.supplier_address}}</span>
                    </div>
                    <div class="info-row" *ngIf="extractedData?.supplier_tax_id">
                        <span class="label">Tax ID:</span>
                        <span class="value">{{extractedData?.supplier_tax_id}}</span>
                    </div>
                </mat-card-content>
            </mat-card>

            <mat-card *ngIf="extractedData?.vehicle_plate || extractedData?.vehicle_vin || extractedData?.mileage" class="mg-surface-card">
                <mat-card-header>
                    <mat-card-title>Vehicle Information</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="info-row" *ngIf="extractedData?.vehicle_plate">
                        <span class="label">License Plate:</span>
                        <span class="value">{{extractedData?.vehicle_plate}}</span>
                    </div>
                    <div class="info-row" *ngIf="extractedData?.vehicle_vin">
                        <span class="label">VIN:</span>
                        <span class="value">{{extractedData?.vehicle_vin}}</span>
                    </div>
                    <div class="info-row" *ngIf="extractedData?.mileage">
                        <span class="label">Mileage:</span>
                        <span class="value">{{extractedData?.mileage}} km</span>
                    </div>
                </mat-card-content>
            </mat-card>

            <ng-container *ngIf="invoice?.status === 'approved'">
                <mat-card *ngFor="let maintenance of maintenances" class="mg-surface-card">
                    <mat-card-header>
                        <mat-card-title>Maintenance: {{maintenance.description}}</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="info-row" *ngIf="maintenance.cost">
                            <span class="label">Total Cost:</span>
                            <span class="value price">{{maintenance.cost | currency:'EUR'}}</span>
                        </div>

                        <div class="parts-list" *ngIf="getPartsByMaintenance(maintenance.id!).length > 0">
                            <h4>Parts</h4>
                            <div class="part-item" *ngFor="let part of getPartsByMaintenance(maintenance.id!)">
                                <div class="part-info">
                                    <span class="part-name">{{part.name}}</span>
                                    <span class="part-ref" *ngIf="part.reference">({{part.reference}})</span>
                                </div>
                                <div class="part-pricing">
                                    {{part.quantity}} x {{part.price | currency:'EUR'}} =
                                    <strong>{{part.quantity * part.price | currency:'EUR'}}</strong>
                                </div>
                            </div>
                        </div>
                    </mat-card-content>
                </mat-card>
            </ng-container>

            <ng-container *ngIf="invoice?.status === 'review'">
                <mat-card *ngFor="let maintenance of extractedData?.maintenances" class="mg-surface-card">
                    <mat-card-header>
                        <mat-card-title>Maintenance: {{maintenance.description}}</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="info-row" *ngIf="maintenance.labor_cost">
                            <span class="label">Labor Cost:</span>
                            <span class="value" [matTooltip]="'With Tax: ' + (getAmountAfterTax(maintenance.labor_cost) | currency:'EUR')">
                                {{maintenance.labor_cost | currency:'EUR'}}
                            </span>
                        </div>

                        <div class="parts-list" *ngIf="maintenance.parts && maintenance.parts.length > 0">
                            <h4>Parts</h4>
                            <div class="part-item" *ngFor="let part of maintenance.parts">
                                <div class="part-info">
                                    <span class="part-name">{{part.name}}</span>
                                    <span class="part-ref" *ngIf="part.reference">({{part.reference}})</span>
                                </div>
                                <div class="part-pricing">
                                    {{part.quantity}} x {{part.unit_price | currency:'EUR'}} =
                                    <strong>{{part.total_price | currency:'EUR'}}</strong>
                                </div>
                            </div>
                        </div>
                    </mat-card-content>
                </mat-card>
            </ng-container>

            <mat-card *ngIf="invoice?.status === 'approved' && getPartsOnly().length > 0" class="mg-surface-card">
                <mat-card-header>
                    <mat-card-title>Parts Purchase</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="parts-list">
                        <div class="part-item" *ngFor="let part of getPartsOnly()">
                            <div class="part-info">
                                <span class="part-name">{{part.name}}</span>
                                <span class="part-ref" *ngIf="part.reference">({{part.reference}})</span>
                            </div>
                            <div class="part-pricing">
                                {{part.quantity}} x {{part.price | currency:'EUR'}} =
                                <strong>{{part.quantity * part.price | currency:'EUR'}}</strong>
                            </div>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <mat-card *ngIf="invoice?.status === 'review' && extractedData?.parts_only?.length" class="mg-surface-card">
                <mat-card-header>
                    <mat-card-title>Parts Purchase</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="parts-list">
                        <div class="part-item" *ngFor="let part of extractedData?.parts_only">
                            <div class="part-info">
                                <span class="part-name">{{part.name}}</span>
                                <span class="part-ref" *ngIf="part.reference">({{part.reference}})</span>
                            </div>
                            <div class="part-pricing">
                                {{part.quantity}} x {{part.unit_price | currency:'EUR'}} =
                                <strong>{{part.total_price | currency:'EUR'}}</strong>
                            </div>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>

        <div class="preview-column">
            <mat-card class="mg-surface-card preview-card">
                <mat-card-header>
                    <mat-card-title>Invoice Image</mat-card-title>
                    <mat-card-subtitle>Click to enlarge</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content class="preview-content" (click)="openImagePreview()">
                    <div class="image-container" *ngIf="invoice?.file_url; else noImage">
                        <img [src]="invoice?.file_url" alt="Invoice Preview">
                        <div class="overlay">
                            <mat-icon>zoom_in</mat-icon>
                        </div>
                    </div>
                    <ng-template #noImage>
                        <div class="no-image">
                            <mat-icon>image_not_supported</mat-icon>
                            <p>No preview available</p>
                        </div>
                    </ng-template>
                </mat-card-content>
            </mat-card>
        </div>
    </div>
</div>

<ng-template #loadingTpl>
    <app-page-loader
        icon="receipt_long"
        message="Loading invoice details..."
        minHeight="300px">
    </app-page-loader>
</ng-template>
