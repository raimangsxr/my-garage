<div class="review-container">
    <div class="header">
        <h1>Review Invoice Data</h1>
        <p>Verify and correct the data extracted by Gemini AI before approving.</p>
    </div>

    <div class="content-grid" *ngIf="!loading">
        <!-- Left Column: Form -->
        <div class="form-column">
            <form [formGroup]="reviewForm">

                <!-- General Info -->
                <mat-card class="section-card">
                    <mat-card-header>
                        <mat-card-title>General Information</mat-card-title>
                    </mat-card-header>
                    <mat-card-content class="form-grid">
                        <mat-form-field appearance="outline">
                            <mat-label>Invoice Number</mat-label>
                            <input matInput formControlName="invoice_number">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Date</mat-label>
                            <input matInput [matDatepicker]="picker" formControlName="invoice_date">
                            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Subtotal</mat-label>
                            <input matInput type="number" formControlName="subtotal">
                            <span matPrefix>€&nbsp;</span>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Tax Amount (IVA)</mat-label>
                            <input matInput type="number" formControlName="tax_amount">
                            <span matPrefix>€&nbsp;</span>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Total Amount</mat-label>
                            <input matInput type="number" formControlName="total_amount">
                            <span matPrefix>€&nbsp;</span>
                            <mat-error *ngIf="!isTotalValid">
                                Sum of Subtotal + Tax does not match Total!
                            </mat-error>
                        </mat-form-field>

                        <div class="validation-warning" *ngIf="!isTotalValid">
                            <mat-icon color="warn">warning</mat-icon>
                            <span>Subtotal + Tax != Total</span>
                        </div>
                    </mat-card-content>
                </mat-card>

                <!-- Supplier Info -->
                <mat-card class="section-card">
                    <mat-card-header>
                        <mat-card-title>Supplier</mat-card-title>
                    </mat-card-header>
                    <mat-card-content class="form-grid">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Name</mat-label>
                            <input matInput formControlName="supplier_name">
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Address</mat-label>
                            <input matInput formControlName="supplier_address">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Tax ID (NIF/CIF)</mat-label>
                            <input matInput formControlName="supplier_tax_id">
                        </mat-form-field>
                    </mat-card-content>
                </mat-card>

                <!-- Vehicle Info -->
                <mat-card class="section-card">
                    <mat-card-header>
                        <mat-card-title>Vehicle</mat-card-title>
                    </mat-card-header>
                    <mat-card-content class="form-grid">
                        <div class="row">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Assign to Vehicle</mat-label>
                                <mat-select formControlName="vehicle_id">
                                    <mat-option [value]="null">-- None --</mat-option>
                                    <mat-option *ngFor="let v of vehicles" [value]="v.id">
                                        {{v.brand}} {{v.model}} ({{v.license_plate}})
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>

                        <div class="row">
                            <mat-form-field appearance="outline">
                                <mat-label>License Plate (Extracted)</mat-label>
                                <input matInput formControlName="vehicle_plate">
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>Mileage</mat-label>
                                <input matInput type="number" formControlName="mileage">
                                <span matSuffix>km</span>
                            </mat-form-field>
                        </div>
                    </mat-card-content>
                </mat-card>

                <!-- Maintenances -->
                <div formArrayName="maintenances">
                    <mat-card *ngFor="let maintenance of maintenances.controls; let i=index" [formGroupName]="i"
                        class="section-card maintenance-card">
                        <mat-card-header>
                            <mat-card-title>Maintenance #{{i+1}}</mat-card-title>
                        </mat-card-header>
                        <mat-card-content>
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Description</mat-label>
                                <textarea matInput formControlName="description" rows="2"></textarea>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>Labor Cost</mat-label>
                                <input matInput type="number" formControlName="labor_cost"
                                    [matTooltip]="'With Tax: ' + (getAmountAfterTax(maintenance.get('labor_cost')?.value) | currency:'EUR')">
                                <span matPrefix>€&nbsp;</span>
                            </mat-form-field>

                            <!-- Parts in Maintenance -->
                            <div formArrayName="parts">
                                <h4>Parts</h4>
                                <div *ngFor="let part of getParts(i).controls; let j=index" [formGroupName]="j"
                                    class="part-row">
                                    <mat-form-field appearance="outline" class="part-name">
                                        <mat-label>Name</mat-label>
                                        <input matInput formControlName="name">
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="part-qty">
                                        <mat-label>Qty</mat-label>
                                        <input matInput type="number" formControlName="quantity">
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="part-price">
                                        <mat-label>Price</mat-label>
                                        <input matInput type="number" formControlName="unit_price"
                                            [matTooltip]="'With Tax: ' + (getAmountAfterTax(part.get('unit_price')?.value) | currency:'EUR')">
                                    </mat-form-field>
                                </div>
                            </div>
                        </mat-card-content>
                    </mat-card>
                </div>

                <!-- Parts Only -->
                <div formArrayName="parts_only" *ngIf="partsOnly.length > 0">
                    <mat-card class="section-card">
                        <mat-card-header>
                            <mat-card-title>Parts Purchase</mat-card-title>
                        </mat-card-header>
                        <mat-card-content>
                            <div *ngFor="let part of partsOnly.controls; let i=index" [formGroupName]="i"
                                class="part-row">
                                <mat-form-field appearance="outline" class="part-name">
                                    <mat-label>Name</mat-label>
                                    <input matInput formControlName="name">
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="part-qty">
                                    <mat-label>Qty</mat-label>
                                    <input matInput type="number" formControlName="quantity">
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="part-price">
                                    <mat-label>Price</mat-label>
                                    <input matInput type="number" formControlName="unit_price"
                                        [matTooltip]="'With Tax: ' + (getAmountAfterTax(part.get('unit_price')?.value) | currency:'EUR')">
                                </mat-form-field>
                            </div>
                        </mat-card-content>
                    </mat-card>
                </div>

            </form>
        </div>

        <!-- Right Column: Actions & Preview (Placeholder) -->
        <div class="actions-column">
            <mat-card class="actions-card">
                <mat-card-content>
                    <button mat-raised-button color="primary" class="full-width" (click)="approveInvoice()"
                        [disabled]="approving || reviewForm.invalid">
                        <mat-icon>check_circle</mat-icon>
                        Approve & Create Records
                    </button>

                    <button mat-stroked-button color="warn" class="full-width" style="margin-top: 1rem;"
                        (click)="rejectInvoice()">
                        <mat-icon>cancel</mat-icon>
                        Reject
                    </button>
                </mat-card-content>
            </mat-card>

            <!-- TODO: Add Invoice Image Preview here -->
            <div class="invoice-preview">
                <mat-card>
                    <mat-card-header>
                        <mat-card-title>Original Invoice</mat-card-title>
                        <mat-card-subtitle>Click to enlarge</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content class="preview-content" (click)="openImagePreview()">
                        <div class="image-container" *ngIf="previewUrl; else noImage">
                            <img [src]="previewUrl" alt="Invoice Preview">
                            <div class="overlay">
                                <mat-icon>zoom_in</mat-icon>
                            </div>
                        </div>
                        <ng-template #noImage>
                            <div class="no-image">
                                <mat-icon>image_not_supported</mat-icon>
                                <p>No preview available</p>
                            </div>
                        </ng-template>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </div>