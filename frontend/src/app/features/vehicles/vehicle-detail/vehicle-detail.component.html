<div class="vehicle-detail-container" *ngIf="!loading && vehicleDetails">
    <!-- Hero Section with Toggle -->
    <div class="hero-wrapper">
        <app-vehicle-hero [vehicle]="{
                brand: vehicleDetails.vehicle.brand,
                model: vehicleDetails.vehicle.model,
                license_plate: vehicleDetails.vehicle.license_plate,
                image_url: vehicleDetails.vehicle.image_url
            }" (backClick)="goBack()">
        </app-vehicle-hero>

        <!-- View Mode Toggle (only for track/both vehicles) -->
        <div class="view-mode-toggle" *ngIf="showViewModeToggle">
            <mat-button-toggle-group [(value)]="viewMode" (change)="toggleViewMode()">
                <mat-button-toggle value="street">
                    <mat-icon>add_road</mat-icon>
                    <span>Street</span>
                </mat-button-toggle>
                <mat-button-toggle value="track">
                    <mat-icon>sports_score</mat-icon>
                    <span>Track</span>
                </mat-button-toggle>
            </mat-button-toggle-group>
        </div>
    </div>

    <!-- Stats Bar -->
    <app-vehicle-stats-bar [vehicle]="{
            year: vehicleDetails.vehicle.year,
            kilometers: vehicleDetails.vehicle.kilometers,
            next_itv_date: vehicleDetails.vehicle.next_itv_date
        }" [specs]="vehicleDetails.specs" [trackStats]="trackStats">
    </app-vehicle-stats-bar>

    <!-- Street View -->
    <div class="entities-grid" *ngIf="viewMode === 'street'">
        <!-- Maintenances Column -->
        <app-entity-column title="Mantenimientos" icon="history" [count]="vehicleDetails.maintenances.length">
            <div header-actions class="torque-actions">
                <button mat-icon-button (click)="maintenanceTimeline.toggleSearchMode()"
                    [color]="maintenanceTimeline.isSearchMode ? 'accent' : ''" title="Search maintenance">
                    <mat-icon>search</mat-icon>
                </button>
            </div>
            <app-maintenance-timeline #maintenanceTimeline [maintenances]="vehicleDetails.maintenances"
                (maintenanceClick)="openMaintenanceDialog($event)">
            </app-maintenance-timeline>
        </app-entity-column>

        <!-- Parts Column -->
        <app-entity-column title="Recambios" icon="extension" [count]="parts.length">
            <div header-actions class="torque-actions">
                <button mat-icon-button (click)="partsList.toggleSearchMode()"
                    [color]="partsList.isSearchMode ? 'accent' : ''" title="Search parts">
                    <mat-icon>search</mat-icon>
                </button>
            </div>
            <app-vehicle-parts-list #partsList [parts]="parts" (partClick)="openPartDialog($event)">
            </app-vehicle-parts-list>
        </app-entity-column>

        <!-- Invoices Column -->
        <app-entity-column title="Facturas" icon="receipt" [count]="vehicleDetails.invoices?.length || 0">
            <div header-actions class="torque-actions">
                <button mat-icon-button (click)="openInvoiceUpload()" title="Upload Invoice">
                    <mat-icon>cloud_upload</mat-icon>
                </button>
            </div>

            <div class="invoice-list">
                <app-entity-card *ngFor="let invoice of vehicleDetails.invoices"
                    (cardClick)="openInvoiceDetails(invoice.id)">
                    <div class="invoice-item">
                        <div class="invoice-icon">
                            <mat-icon>description</mat-icon>
                        </div>
                        <div class="invoice-info">
                            <span class="invoice-number">{{ invoice.number || 'Processing...' }}</span>
                            <span class="invoice-date">{{ invoice.date | date }}</span>
                        </div>
                        <span class="invoice-amount">{{ invoice.amount | currency:'EUR' }}</span>
                    </div>
                </app-entity-card>

                <app-empty-state *ngIf="!vehicleDetails.invoices?.length" icon="receipt" message="No invoices yet">
                </app-empty-state>
            </div>
        </app-entity-column>

        <!-- Torque Specifications Column -->
        <app-entity-column title="Torque Specs" icon="build_circle"
            [count]="vehicleDetails.specs?.torque_specs?.length || 6">

            <div header-actions class="torque-actions">
                <button mat-icon-button (click)="torqueSpecs.toggleSearchMode()" *ngIf="!torqueSpecs.isEditMode"
                    [color]="torqueSpecs.isSearchMode ? 'accent' : ''" title="Search specs">
                    <mat-icon>search</mat-icon>
                </button>
                <button mat-icon-button (click)="torqueSpecs.toggleEditMode()" *ngIf="!torqueSpecs.isEditMode"
                    title="Edit specs">
                    <mat-icon>edit</mat-icon>
                </button>
                <div class="edit-actions" *ngIf="torqueSpecs.isEditMode">
                    <button mat-icon-button (click)="torqueSpecs.toggleEditMode()" title="Cancel">
                        <mat-icon>close</mat-icon>
                    </button>
                    <button mat-icon-button (click)="torqueSpecs.save()" title="Save">
                        <mat-icon>check</mat-icon>
                    </button>
                </div>
            </div>

            <app-torque-specs #torqueSpecs [specs]="vehicleDetails.specs?.torque_specs"
                (saveSpecs)="onSaveTorqueSpecs($event)">
            </app-torque-specs>
        </app-entity-column>
    </div>

    <!-- Track View -->
    <div class="track-view" *ngIf="viewMode === 'track'">
        <div class="track-stats-summary">
            <div class="stat-item">
                <mat-icon>sports_score</mat-icon>
                <div class="stat-content">
                    <span class="stat-label">Total Sessions</span>
                    <span class="stat-value">{{ trackRecords.length }}</span>
                </div>
            </div>
            <div class="stat-item">
                <mat-icon>pin_drop</mat-icon>
                <div class="stat-content">
                    <span class="stat-label">Circuits Visited</span>
                    <span class="stat-value">{{ (trackRecords | unique:'circuit_name').length || 0 }}</span>
                </div>
            </div>
            <div class="stat-item" *ngIf="trackRecords.length > 0">
                <mat-icon>timer</mat-icon>
                <div class="stat-content">
                    <span class="stat-label">Best Overall</span>
                    <span class="stat-value">{{ trackRecords[0]?.best_lap_time || 'N/A' }}</span>
                </div>
            </div>
        </div>

        <app-track-records [records]="trackRecords" (recordAdded)="onTrackRecordAdded($event)"
            (recordUpdated)="onTrackRecordUpdated($event)" (recordDeleted)="onTrackRecordDeleted($event)">
        </app-track-records>
    </div>
</div>

<div *ngIf="loading" class="loading-container">
    <mat-icon>add_road</mat-icon>
    <p>Loading vehicle details...</p>
</div>