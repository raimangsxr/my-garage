<div class="vehicle-detail-container" *ngIf="!loading && vehicleDetails">
    <!-- Hero Section -->
    <app-vehicle-hero [vehicle]="{
            brand: vehicleDetails.vehicle.brand,
            model: vehicleDetails.vehicle.model,
            license_plate: vehicleDetails.vehicle.license_plate,
            image_url: vehicleDetails.vehicle.image_url
        }" (backClick)="goBack()">
    </app-vehicle-hero>

    <!-- Stats Bar -->
    <app-vehicle-stats-bar [vehicle]="{
            year: vehicleDetails.vehicle.year,
            kilometers: vehicleDetails.vehicle.kilometers,
            next_itv_date: vehicleDetails.vehicle.next_itv_date
        }" [specs]="vehicleDetails.specs">
    </app-vehicle-stats-bar>

    <!-- Related Entities Grid -->
    <div class="entities-grid">
        <!-- Maintenances Column -->
        <app-entity-column title="Mantenimientos" icon="history" [count]="vehicleDetails.maintenances.length">
            <div header-actions class="torque-actions">
                <button mat-icon-button (click)="maintenanceTimeline.toggleSearchMode()"
                    [color]="maintenanceTimeline.isSearchMode ? 'accent' : ''" title="Search maintenance">
                    <mat-icon>search</mat-icon>
                </button>
            </div>
            <app-maintenance-timeline #maintenanceTimeline [maintenances]="vehicleDetails.maintenances"
                (maintenanceClick)="openMaintenanceDialog($event)">
            </app-maintenance-timeline>
        </app-entity-column>

        <!-- Parts Column -->
        <app-entity-column title="Recambios" icon="extension" [count]="parts.length">
            <div header-actions class="torque-actions">
                <button mat-icon-button (click)="partsList.toggleSearchMode()"
                    [color]="partsList.isSearchMode ? 'accent' : ''" title="Search parts">
                    <mat-icon>search</mat-icon>
                </button>
            </div>
            <app-vehicle-parts-list #partsList [parts]="parts" (partClick)="openPartDialog($event)">
            </app-vehicle-parts-list>
        </app-entity-column>

        <!-- Torque Specifications Column -->
        <app-entity-column title="Torque Specs" icon="build_circle"
            [count]="vehicleDetails.specs?.torque_specs?.length || 6">

            <div header-actions class="torque-actions">
                <button mat-icon-button (click)="torqueSpecs.toggleSearchMode()" *ngIf="!torqueSpecs.isEditMode"
                    [color]="torqueSpecs.isSearchMode ? 'accent' : ''" title="Search specs">
                    <mat-icon>search</mat-icon>
                </button>
                <button mat-icon-button (click)="torqueSpecs.toggleEditMode()" *ngIf="!torqueSpecs.isEditMode"
                    title="Edit specs">
                    <mat-icon>edit</mat-icon>
                </button>
                <div class="edit-actions" *ngIf="torqueSpecs.isEditMode">
                    <button mat-icon-button (click)="torqueSpecs.toggleEditMode()" title="Cancel">
                        <mat-icon>close</mat-icon>
                    </button>
                    <button mat-icon-button (click)="torqueSpecs.save()" title="Save">
                        <mat-icon>check</mat-icon>
                    </button>
                </div>
            </div>

            <app-torque-specs #torqueSpecs [specs]="vehicleDetails.specs?.torque_specs"
                (saveSpecs)="onSaveTorqueSpecs($event)">
            </app-torque-specs>
        </app-entity-column>
    </div>
</div>

<div *ngIf="loading" class="loading-container">
    <mat-icon>directions_car</mat-icon>
    <p>Loading vehicle details...</p>
</div>